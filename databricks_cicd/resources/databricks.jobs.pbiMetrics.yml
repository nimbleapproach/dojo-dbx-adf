# Databricks Jobs Configuration.
# This file defines the jobs and their configurations for deployment to Databricks.
# Each job can represent a notebook, library, or other executable entity within Databricks.
## for additional options please see schema.json in that repository (can be generated by "databricks bundle schema" command)
resources:
  jobs:
    inf_edw_pbi_metrics: # Provide a unique name for this bundle. This name should differentiate it from other projects.
      name: inf_edw_pbi_metrics # Provide a unique name for this job. This name should differentiate it from other jobs.
      schedule:
        quartz_cron_expression: '0 0 4 ? * * *'
        timezone_id: Europe/Amsterdam
      
      email_notifications:
        on_failure:
          - ${var.email_team_notification}
          - ${var.email_mailbox_notification}
        no_alert_for_skipped_runs: false
      permissions:
        - group_name: users
          level: CAN_MANAGE_RUN
      
      tasks:
        - task_key: get_metric_data
          description: task to load metric data from the api into bronze
          notebook_task:
            notebook_path: ../notebooks/bronze/powerbi/nb-powerbi-metrics-pull.py
          existing_cluster_id: ${var.existing_cluster_id}
          max_retries: 0
          min_retry_interval_millis: 100000
          retry_on_timeout: true

        - task_key: load_daily_metrics_to_silver
          depends_on:
            - task_key: get_metric_data
          description: task to load metric data from bronze to silver
          notebook_task:
            notebook_path: ../notebooks/silver/powerbi/nb-powerbi-metrics-silver.py
          existing_cluster_id: ${var.existing_cluster_id}
          max_retries: 0
          min_retry_interval_millis: 100000
          retry_on_timeout: true

        - task_key: load_daily_usage_metrics_to_gold
          depends_on:
            - task_key: load_daily_metrics_to_silver
          description: task to load metric data from silver into gold tables
          notebook_task:
            notebook_path: ../notebooks/gold/powerbi/nb-powerbi-usage-metrics-gold.py
          existing_cluster_id: ${var.existing_cluster_id}
          max_retries: 0
          min_retry_interval_millis: 100000
          retry_on_timeout: true

        - task_key: load_daily_refresh_metrics_to_gold
          depends_on:
            - task_key: load_daily_metrics_to_silver
          description: task to load metric data from silver into gold tables
          notebook_task:
            notebook_path: ../notebooks/gold/powerbi/nb-powerbi-refresh-metrics-gold.py
          existing_cluster_id: ${var.existing_cluster_id}
          max_retries: 0
          min_retry_interval_millis: 100000
          retry_on_timeout: true